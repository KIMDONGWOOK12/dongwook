(()=>{"use strict";var e={11:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});class r{hostname;user;port;constructor(e,t,r){this.hostname=e,this.user=t,this.port=r}static parse(e){let t;const n=e.lastIndexOf("@");let o;-1!==n&&(t=e.substring(0,n));const a=e.lastIndexOf(":");-1!==a&&(o=parseInt(e.substring(a+1),10));const s=-1!==n?n+1:0,i=-1!==a?a:e.length,c=e.substring(s,i);return new r(c,t,o)}toString(){let e=this.hostname;return this.user&&(e=`${this.user}@`+e),this.port&&(e+=`:${this.port}`),e}static parseEncoded(e){try{const t=JSON.parse(Buffer.from(e,"hex").toString());return new r(t.hostName,t.user,t.port)}catch{}return r.parse(e.replace(/\\x([0-9a-f]{2})/g,(e,t)=>String.fromCharCode(parseInt(t,16))))}toEncodedString(){return this.toString().replace(/[A-Z]/g,e=>`\\x${e.charCodeAt(0).toString(16).toLowerCase()}`)}}t.default=r},23:e=>{e.exports=require("util")},144:function(e,t,r){var n,o=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var o=Object.getOwnPropertyDescriptor(t,r);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,o)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||(n=function(e){return n=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},n(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=n(e),s=0;s<r.length;s++)"default"!==r[s]&&o(t,e,r[s]);return a(t,e),t}),i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.activate=async function(e){e.subscriptions.push(c.commands.registerCommand("browserLauncher.warmUpBrowser",async()=>(E.instance||(E.instance=new E),await E.instance.warmUp()))),e.subscriptions.push(c.commands.registerCommand("browserLauncher.launchBrowser",async e=>(E.instance||(E.instance=new E),await E.instance.launch(e)))),e.subscriptions.push(c.commands.registerCommand("browserLauncher.resetBrowserOnboarding",async()=>{await async function(){const e=u.BrowserLauncherOutputChannel.getInstance(),t=D();try{p.existsSync(t)?(e.appendLine(`Deleting Chrome profile at: ${t}`),await p.promises.rm(t,{recursive:!0,force:!0}),e.appendLine("Successfully deleted Chrome profile."),c.window.showInformationMessage("Successfully deleted Chrome profile.")):(e.appendLine(`Chrome profile not found at: ${t}`),c.window.showInformationMessage("Chrome profile not found."))}catch(t){e.appendLine(`Failed to delete Chrome profile: ${t.message}`),c.window.showErrorMessage(`Failed to delete Chrome profile: ${t.message}`)}try{await c.commands.executeCommand("antigravity.resetOnboardingBackend"),c.window.showInformationMessage("Successfully reset onboarding.")}catch(t){e.appendLine(`Failed to reset onboarding: ${t.message}`),c.window.showErrorMessage(`Failed to reset onboarding: ${t.message}`)}setTimeout(()=>{c.commands.executeCommand("workbench.action.reloadWindow")},1e3)}()}))},t.deactivate=function(){};const c=s(r(398)),u=r(377),l=r(317),p=s(r(896)),h=s(r(857)),d=s(r(928)),m=s(r(23)),f=i(r(11)),g=r(503),w=m.promisify(l.exec),b="https://www.google.com/chrome/";class y extends Error{constructor(e){super(e),this.name="ChromeInstallationError"}}class C extends Error{constructor(e){super(e),this.name="UserDataDirPolicyError"}}let _,v,L,O,P=null;const x=["/Applications/Google Chrome.app/Contents/MacOS/Google Chrome","/usr/bin/google-chrome","/usr/bin/chromium-browser","C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe"],$=["/Applications/Chromium.app/Contents/MacOS/Chromium","/usr/bin/google-chrome-stable","/usr/bin/chromium","/snap/bin/chromium","/usr/bin/google-chrome-beta","/opt/google/chrome/chrome","C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe","C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe",process.env.LOCALAPPDATA?`${process.env.LOCALAPPDATA}\\Google\\Chrome\\Application\\chrome.exe`:"",process.env.PROGRAMFILES?`${process.env.PROGRAMFILES}\\Google\\Chrome\\Application\\chrome.exe`:"","C:\\Program Files\\Chromium\\Application\\chrome.exe","C:\\Program Files (x86)\\Chromium\\Application\\chrome.exe"].filter(Boolean),S=()=>{const e=_;if(e&&e.trim())return e.trim();const t=[...x,...$];for(const e of t)if(p.existsSync(e))return e},D=()=>{const e=v;return e&&e.trim()?e.trim():d.join(h.homedir(),".gemini","antigravity-browser-profile")},M=()=>L&&L>0?L:9222,I=async(e,t,r=3e4)=>{const n=u.BrowserLauncherOutputChannel.getInstance();for(;Date.now()-t<r;)try{await w(`curl -s http://127.0.0.1:${e}/json/version`,{timeout:500});const r=Date.now()-t;return void n.appendLine(`Browser ready on port ${e} after ${r}ms`)}catch(e){await new Promise(e=>setTimeout(e,100))}n.appendLine(`Browser startup timed out after ${r}ms on port ${e}`)},A=(e,t,r)=>{const n=u.BrowserLauncherOutputChannel.getInstance();if("darwin"===h.platform()){const o=["--new"];return r||o.push("--background"),o.push("-a",e,"--args",...t),O=`open ${o.join(" ")}`,n.appendLine(`Launching browser with command: ${O}`),(0,l.spawn)("open",o,{detached:!0,stdio:"ignore",shell:!1})}return O=`"${e}" ${t.join(" ")}`,n.appendLine(`Launching browser with command: ${O}`),(0,l.spawn)(e,t,{detached:!0,stdio:"ignore",shell:!1})},B=async()=>{const e=u.BrowserLauncherOutputChannel.getInstance(),t=M();try{return await w(`curl -s http://127.0.0.1:${t}/json/version`,{timeout:500}),e.appendLine(`Chrome with CDP is already running on port ${t}.`),!0}catch(r){return e.appendLine(`No Chrome with CDP found on port ${t}. Safe to launch Chrome.`),!1}},j=async e=>{if(await B())return!1;const t=u.BrowserLauncherOutputChannel.getInstance(),r=S();if(!r){const e=`Chrome installation not found. Please install Google Chrome at ${b} or set a custom Chrome binary path in the browser section of the Antigravity user settings.`;throw t.appendLine(e),c.window.showErrorMessage("Chrome installation not detected and is required for browser agent features.",{modal:!0},{title:"Install Chrome"},{title:"Set custom Chrome binary path"}).then(e=>{"Install Chrome"===e?.title?c.env.openExternal(c.Uri.parse(b)):"Set custom Chrome binary path"===e?.title&&c.commands.executeCommand("workbench.action.openAntigravitySettingsWithId","browserChromePath")}),new y(e)}if(/chrome/i.test(r)&&!/chromium/i.test(r)&&!/chrome for testing/i.test(r)&&await(async()=>{const e=h.platform();try{if("win32"===e){const e="1"===(await w('reg query "HKLM\\SOFTWARE\\Policies\\Google\\Chrome" /v UserDataDir >nul 2>nul && echo 1 || echo 0')).stdout.trim(),t="1"===(await w('reg query "HKCU\\SOFTWARE\\Policies\\Google\\Chrome" /v UserDataDir >nul 2>nul && echo 1 || echo 0')).stdout.trim();return e||t}if("darwin"===e){const e='\nimport objc\nfrom Foundation import CFPreferencesCopyAppValue, CFPreferencesAppValueIsForced\nbundle_id = "com.google.Chrome"\nkey = "UserDataDir"\nvalue = CFPreferencesCopyAppValueUnsafe(key, bundle_id) if hasattr(objc, "CFPreferencesCopyAppValueUnsafe") else CFPreferencesCopyAppValue(key, bundle_id)\nis_forced = CFPreferencesAppValueIsForced(key, bundle_id)\nprint(1) if value and is_forced else print(0)\n'.trim();try{if("1"===(await w(`python3 -c '${e}'`)).stdout.trim())return!0}catch(e){return"1"===(await w('defaults read "/Library/Managed Preferences/com.google.Chrome" UserDataDir 2>/dev/null && echo 1 || echo 0')).stdout.trim()}}else if("linux"===e)return"1"===(await w('grep -r "UserDataDir" /etc/opt/chrome/policies 2>/dev/null && echo 1 || echo 0')).stdout.trim()}catch(e){return!1}return!1})()){const e="Antigravity Browser needs to use a separate user profile, but Chrome user profile is enforced by your admin policy. Please contact your admin to unset UserDataDir or try use Chromium.";throw t.appendLine(e),c.window.showErrorMessage(e,{modal:!0}),new C(e)}const n=(()=>{const e=c.workspace.getConfiguration("codeiumDev").get("browserLaunchFlags");return e&&e.length>0?e:[`--remote-debugging-port=${M()}`,`--user-data-dir=${D()}`,"--disable-fre","--no-default-browser-check","--no-first-run","--auto-accept-browser-signin-for-tests","--ash-no-nudges","--disable-features=OfferMigrationToDiceUsers,OptGuideOnDeviceModel"]})();return A(r,n,e).unref(),!0};class E{static instance=null;runningWarmup=null;runningLaunch=null;async launch(e){return this.runningLaunch||(this.runningWarmup&&await this.runningWarmup,this.runningLaunch=async function(e){const t=u.BrowserLauncherOutputChannel.getInstance();try{t.appendLine("Launching browser...");const r=Date.now();await async function(){try{[_,v,L]=await Promise.all([c.antigravityUnifiedStateSync.BrowserPreferences.getBrowserChromePath(),c.antigravityUnifiedStateSync.BrowserPreferences.getBrowserUserProfilePath(),c.antigravityUnifiedStateSync.BrowserPreferences.getBrowserCdpPort()])}catch(e){console.error("[Browser Launcher] Failed to load browser settings:",e)}}();const n=!await j(e);if((async()=>{const e=c.env.remoteAuthority,t=u.BrowserLauncherOutputChannel.getInstance();if(t.appendLine("Starting SSH reverse proxy..."),e&&e.startsWith("ssh-remote+")){P&&(P.kill(),P=null);const r=e.split("+");if(r.length<2)return void t.appendLine("Warning: Invalid remote authority format. Expected ssh-remote+<hostData>");const n=r[1],o=f.default.parseEncoded(n),a=o.user?`${o.user}@${o.hostname}`:o.hostname,s=M(),i=s,u=s;let p=null;try{const e=await c.commands.executeCommand("antigravity.getChromeDevtoolsMcpUrl");if(e){const r=new URL(e);if(r.port){const e=parseInt(r.port,10);!isNaN(e)&&e>0?(p=e,t.appendLine(`MCP proxy port detected: ${p}`)):t.appendLine(`Invalid MCP proxy port parsed: ${r.port}`)}else t.appendLine(`Warning: MCP URL missing port (unexpected): ${e}`)}}catch(e){t.appendLine(`Failed to get MCP proxy port: ${e instanceof Error?e.message:String(e)}`)}const h=["-R",`${u}:127.0.0.1:${i}`];p&&(h.push("-R",`${p}:127.0.0.1:${p}`),t.appendLine(`Forwarding MCP proxy port ${p} over SSH tunnel`)),h.push(a,"-N","-o","ExitOnForwardFailure=yes","-o","LogLevel=ERROR","-o","StreamLocalBindUnlink=yes"),P=(0,l.spawn)("ssh",h)}else t.appendLine("Not in remote SSH session. Skipping reverse proxy initialization.")})().catch(e=>{t.appendLine(`Proxy init failed: ${e}`)}),!n){const e=M();await c.window.withProgress({location:c.ProgressLocation.Notification,title:"Launching browser...",cancellable:!0},async(e,t)=>{await(async(e,t)=>{const r=u.BrowserLauncherOutputChannel.getInstance(),n=Date.now();for(;!await B();){if(Date.now()-n>2e4){r.appendLine("Timed out waiting for chrome with remote debugging port to be ready.");break}if(await new Promise(e=>setTimeout(e,500)),t.isCancellationRequested)break}})(0,t)}),I(e,r,5e3)}const o="http://127.0.0.1:"+M();return n?(0,g.hasDevExtension)()&&c.window.showInformationMessage("Dev: Connected to existing browser."):c.window.showInformationMessage("Successfully launched browser."),o}catch(e){t.appendLine(`Failed to launch browser: ${e.message}`);let r={};r=e instanceof y?{_error_message:"ChromeInstallationError"}:e instanceof C?{_error_message:"UserDataDirPolicyError"}:await async function(e){const t={},r=u.BrowserLauncherOutputChannel.getInstance(),n=M(),o=h.platform();t._error_message=e.message,e.stack&&(t._error_stack=e.stack.substring(0,500));try{let e;e="win32"===o?(await w(`netstat -ano | findstr :${n}`,{timeout:1e3})).stdout.trim():(await w(`lsof -ti:${n}`,{timeout:1e3})).stdout.trim(),t.port_in_use=e?"true":"false",e&&(t.port_scan_output=e)}catch(e){t.port_in_use="false"}t.platform=o;try{let e;if("darwin"===o||"linux"===o)e='pgrep -fl "chrome|chromium"';else{if("win32"!==o)throw new Error("Unsupported platform");e='tasklist /FI "IMAGENAME eq chrome.exe" /V'}const r=(await w(e,{timeout:2e3})).stdout.trim();if(r){t.chrome_processes_found="true",t._chrome_processes=r.substring(0,1e3);const e=r.match(/--remote-debugging-port=(\d+)/g);e&&(t._running_cdp_ports=e.join(", "));const n=r.match(/--user-data-dir=([^\s]+)/g);n&&(t._running_user_data_dirs=n.map(e=>e.substring(0,100)).join(", ").substring(0,300))}else t.chrome_processes_found="false"}catch(e){t.chrome_processes_found="error",r.appendLine(`Failed to get Chrome processes: ${e instanceof Error?e.message:String(e)}`)}return O&&(t._launch_command=O.substring(0,500)),t}(e);try{await c.commands.executeCommand("antigravity.logObservabilityDataAction","BROWSER_LAUNCH_FAILURE_DIAGNOSTICS",{},r)}catch(e){t.appendLine(`Failed to upload diagnostics: ${e instanceof Error?e.message:String(e)}`)}if(e instanceof y||e instanceof C)throw e;return c.window.showErrorMessage(`Failed to launch browser: ${e.message}`),null}}(e),this.runningLaunch.finally(()=>{this.runningLaunch=null})),this.runningLaunch}async warmUp(){if(!this.runningLaunch)return this.runningWarmup||(this.runningWarmup=(async()=>{const e=u.BrowserLauncherOutputChannel.getInstance();e.appendLine("Starting browser warmup...");try{const t=S();if(!t)return void e.appendLine("Chrome not found, skipping warmup.");const r=D(),n=9223,o=[`--user-data-dir=${r}`,`--remote-debugging-port=${n}`,"--headless=new","--disable-gpu","--no-sandbox","--disable-dev-shm-usage","about:blank"],a=Date.now(),s=A(t,o,!1);await I(n,a,5e3),"darwin"===h.platform()?await(async e=>{const t=u.BrowserLauncherOutputChannel.getInstance();try{const r=(await w(`lsof -ti:${e}`)).stdout.trim();if(r){const n=parseInt(r,10);t.appendLine(`Killing process ${n} on port ${e}`),process.kill(n,"SIGTERM")}}catch(r){t.appendLine(`No process found on port ${e} or failed to kill: ${r.message}`)}})(n):s.kill()}catch(t){e.appendLine(`Browser warmup failed: ${t.message}`)}})()),this.runningWarmup}}},317:e=>{e.exports=require("child_process")},377:function(e,t,r){var n,o=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var o=Object.getOwnPropertyDescriptor(t,r);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,o)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||(n=function(e){return n=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},n(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=n(e),s=0;s<r.length;s++)"default"!==r[s]&&o(t,e,r[s]);return a(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.BrowserLauncherOutputChannel=void 0;const i=s(r(398));class c{static instance;static getInstance(){return c.instance||(this.instance=i.window.createOutputChannel("Browser Launcher",{log:!0})),this.instance}}t.BrowserLauncherOutputChannel=c},398:e=>{e.exports=require("vscode")},503:function(e,t,r){var n,o=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var o=Object.getOwnPropertyDescriptor(t,r);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,o)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||(n=function(e){return n=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},n(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r=n(e),s=0;s<r.length;s++)"default"!==r[s]&&o(t,e,r[s]);return a(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.hasDevExtension=function(){return void 0!==i.extensions.getExtension(c)};const i=s(r(398)),c="Codeium.codeium-dev"},857:e=>{e.exports=require("os")},896:e=>{e.exports=require("fs")},928:e=>{e.exports=require("path")}},t={},r=function r(n){var o=t[n];if(void 0!==o)return o.exports;var a=t[n]={exports:{}};return e[n].call(a.exports,a,a.exports,r),a.exports}(144),n=exports;for(var o in r)n[o]=r[o];r.__esModule&&Object.defineProperty(n,"__esModule",{value:!0})})();
//# sourceMappingURL=https://main.vscode-cdn.net/sourcemaps/d2597a5c475647ed306b22de1e39853c7812d07d/extensions/antigravity-browser-launcher/dist/extension.js.map